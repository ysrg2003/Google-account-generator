name: Enterprise Web Automation Engine

on:
  workflow_dispatch: # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ

jobs:
  run-core:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ğŸ“¥ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ (Checkout)
        uses: actions/checkout@v4

      - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø§ÙŠØ«ÙˆÙ† 3.11 (Python Setup)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ› ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­Ø±Ùƒ
        run: |
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          python -m venv venv
          source venv/bin/activate
          
          # 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
          python -m pip install --upgrade pip setuptools wheel
          pip install faker camoufox[nimbus] playwright
          
          # 3. Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© playwright command not found:
          # Ù†Ø³ØªØ®Ø¯Ù… python -m Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙƒØªØ¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          # ÙˆÙ†Ø³ØªØ®Ø¯Ù… --with-deps Ù„ØªØ«Ø¨ÙŠØª Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø§Ø±Ø¶Ø§Øª sudo
          python -m playwright install firefox --with-deps

      
      - name: ğŸ“ Cache Python venv
        uses: actions/cache@v3
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}

      - name: ğŸ”¡ Cache Fonts
        uses: actions/cache@v3
        with:
          path: /usr/share/fonts
          key: ${{ runner.os }}-fonts

      - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ (Deep Execution)
        run: |
          source venv/bin/activate
          
          # Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙˆØ±Ø§Ù‹
          unset GITHUB_ACTIONS
          unset CI
          unset GITHUB_RUN_ID
          export PYTHONUNBUFFERED=1
          xvfb-run --auto-servernum --server-args="-screen 0 1280x800x24" python main.py
        env:
          PYTHONUNBUFFERED: 1

      - name: ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ÙŠØ© (Full Forensic Report)
        if: always() # Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
        uses: actions/upload-artifact@v4
        with:
          name: Full-Trace-Report-Run-${{ github.run_number }}
          path: |
            PRO_ENGINE_*
            *.json
            *.log
          retention-days: 14
